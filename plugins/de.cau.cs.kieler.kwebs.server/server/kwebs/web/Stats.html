<!doctype html>
<html encoding="utf-8">
    <head>
        <meta charset="utf-8">
        <meta http-equiv='content-type' content='text/html; charset=utf-8'>
        
        <title>KIELER KWebS Stats</title>
        
        <!-- Stylesheets -->
        <link rel="stylesheet" href="scripts/styles/xcharts.min.css" />
        
        <!-- Js -->
        <script src="scripts/jquery-1.10.2.min.js" type="text/javascript"></script>
        <script src="scripts/d3.v3.min.js" type="text/javascript"></script>
        <script src="scripts/xcharts.min.js" type="text/javascript"></script>
        <script src="scripts/moment.min.js" type="text/javascript"></script>
        
        <style>
            #tt {
              background: none repeat scroll 0 0 #EEEEEE;
              border-collapse: separate;
              border-radius: 3px;
              box-shadow: 0 1px 3px #000000;
              display: none;
              padding: 5px;
              position: absolute;
            }
        </style>
        
        <script type="text/javascript">
        
            /**
             * props: 
             *    collection: String 
             *    document: String
             *    unit: String
             *      e.g., day or month
             *    noOfUnits: Int
             *      for days e.g. 31, months e.g. 12
             *    dateFormat: String 
             *      e.g., YYYY-MM-DD 
             *    idPrefix: String
             *       prefix of the figure's id in the html document
             */
            function createChart(props) {
              
              var dateFormat = props.dateFormat;
              var noUnits = props.noOfUnits;
              var lstUnit = moment().format(dateFormat);
              var fstUnit = moment().subtract(props.unit, noUnits - 1).format(dateFormat);
              
              // assemble query object here as we need to access it via [] notation 
              var queryObj = {
                name: props.document
              }
              queryObj[props.unit] = {
                '$gte' : fstUnit,
                '$lte' : lstUnit
              }
              
              // same is true for fields
              var fields = {
                'count' : true
              }
              fields[props.unit] = true;
            
              $.ajax({
                  type: 'GET',
                  dataType : 'json',
                  url: 'http://localhost:1337/stats',
                  data: {
                    coll: props.collection,
                    obj: queryObj,
                    fields: fields, 
                    opts: {
                      sort: props.unit
                    }
                  },
                  success: function(data) {                   
                    
                    // create object for every possible element even if there is no db object
                    var units = {};  
                    var chartUnits = [];
                    var count = noUnits - 1;
                    while (count >= 0) {
                      var curUnit = moment().subtract(props.unit, count--).format(dateFormat);
                      units[curUnit] = 0;
                      chartUnits.push({x: curUnit, y: 0});
                    }
                    
                    // map with the retrieved data from the db
                    $.each(data, function(i, row) {
                      units[row[props.unit]] = row.count;
                    });
                    
                    // convert data to xChart representation
                    for (var i = 0; i < chartUnits.length; ++i) {
                      chartUnits[i].y = units[chartUnits[i].x];
                    }
                    
                    // create the chart
                    var chartData = {
                      "xScale": "ordinal",
                      "yScale": "linear",
                      "main": [
                        {
                          "className": ".pizza",
                          "data": chartUnits                            
                        }
                      ]
                    };
                    
                    var opts = {                        
                      "mouseover": function (d, i) {
                        var pos = $(this).offset();
                        $("#tt").html("<small>" + d.x + "</small>" + " (" + d.y + " )")
                          .css({top: pos.top - 10, left: pos.left + 5})
                          .show();
                      },
                      "mouseout": function (x) {
                        $("#tt").hide();
                      }
                    }
                    
                    new xChart('bar', chartData, '#' + props.id, opts);
                  }
                });
            }
            
            createChart({
              collection: "de.cau.cs.kieler.kwebs",
              document: "kwebs.livelayout.try",
              unit: 'month',
              noOfUnits: 12,
              dateFormat: 'YYYY-MM',
              id: "liveLayoutMonthly"
            });
            
            createChart({
                collection: "de.cau.cs.kieler.kwebs",
                document: "kwebs.livelayout.try",
                unit: 'day',
                noOfUnits: 31,
                dateFormat: 'YYYY-MM-DD',
                id: "liveLayoutDaily"
            });
            
            createChart({
              collection: "de.cau.cs.kieler.kwebs",
              document: "kwebs.jaxws.try",
              unit: 'month',
              noOfUnits: 12,
              dateFormat: 'YYYY-MM',
              id: "jaxWSMonthly"
            });
            
            createChart({
                collection: "de.cau.cs.kieler.kwebs",
                document: "kwebs.jaxws.try",
                unit: 'day',
                noOfUnits: 31,
                dateFormat: 'YYYY-MM-DD',
                id: "jaxWSDaily"
            });
        </script>
        
    </head>
    <body>
        <h1>LiveLayout - Monthly</h1>
        <figure style="width: 90%; height: 300px;" id="liveLayoutMonthly"></figure>
        <h1>LiveLayout - Daily</h1>
        <figure style="width: 90%; height: 300px;" id="liveLayoutDaily"></figure>
        <h1>JaxWS - Monthly</h1>
        <figure style="width: 90%; height: 300px;" id="jaxWSMonthly"></figure>
        <h1>JaxWS - Daily</h1>
        <figure style="width: 90%; height: 300px;" id="jaxWSDaily"></figure>
        <div id="tt"></div>
    </body>
</html>


