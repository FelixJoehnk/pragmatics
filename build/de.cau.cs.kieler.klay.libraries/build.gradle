/**
 * Gradle script for building and publishing Klay as bundled jar with and without dependencies.
 */

plugins {
    id 'java'
    id 'signing'
    id 'maven'
    id 'com.github.johnrengelman.shadow' version '1.2.2'
}

import com.github.jengelman.gradle.plugins.shadow.transformers.AppendingTransformer

group = 'de.cau.cs.kieler'
version = '1.3.37'
ext.packaging = 'jar'

sourceSets {
    main {
        java {
            srcDir '../../plugins/de.cau.cs.kieler.core/src'
            srcDir '../../plugins/de.cau.cs.kieler.core.kgraph/src'
            srcDir '../../plugins/de.cau.cs.kieler.kiml/src'
            srcDir '../../plugins/de.cau.cs.kieler.klay.force/src'
            srcDir '../../plugins/de.cau.cs.kieler.klay.layered/src'
            srcDir '../../plugins/de.cau.cs.kieler.klay.tree/src'
        }
    }
}

repositories {
    mavenCentral()
}

dependencies {
    compile 'org.eclipse.emf:org.eclipse.emf.common:[0,)'
    compile 'org.eclipse.emf:org.eclipse.emf.ecore:[0,)'
    compile 'org.eclipse.emf:org.eclipse.emf.ecore.xmi:[0,)'
    compile 'com.google.guava:guava-gwt:[0,)'
}


task sourcesJar (type: Jar) {
    classifier = 'sources'
    from sourceSets.main.allSource
}

task javadoc (type: Javadoc, overwrite: true) {
    source = sourceSets.main.allJava
    failOnError = false
}

task javadocJar (type: Jar, dependsOn: javadoc) {
    classifier = 'javadoc'
    from javadoc.destinationDir
}

artifacts {
    archives jar
    archives sourcesJar
    archives javadocJar
}

shadowJar {
    from "epl-v10.html"
    include '**/*.class'
    include '**/*.jar'
    include 'META-INF/MAINFEST.MF'
    include 'epl-v10.html'
    exclude 'javax/**'
}

signing {
    sign configurations.archives
}

uploadArchives {
    repositories {
        mavenDeployer {
            beforeDeployment { MavenDeployment deployment -> signing.signPom(deployment) }

            repository(url: "file://$buildDir/repo") {
              // authentication(userName: sonatypeUsername, password: sonatypePassword)
            }

            pom.project {
                name 'KlayBundle'
                packaging 'jar'
                description 'Bundled Standalone Klay'
                url 'http://rtsys.informatik.uni-kiel.de'

                licenses {
                    license {
                        name 'Eclipse Public License - v 1.0'
                        url 'http://www.eclipse.org/org/documents/epl-v10.html'
                    }
                }
            }
        }
    }
}
